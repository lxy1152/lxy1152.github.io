---
title: 🖖 DDL
---

## 如何高效处理大库 DDL？

有时希望在不停机的情况下在某张表中添加或删除某个字段，大多数的 `alter table` 操作都会涉及 `lock --> copy to new table --> rename --> unlock` 的过程，数据量太大的情况下，锁表的时间会很长，而且 `alter table` 的进程不可以被杀死，一旦执行就不可回退。

从 MySQL 5.6 开始，Online DDL 特性被引进，它增强了很多种类的 `alter table` 操作避免拷贝表和锁表，在运行 `alter` 操作的同时允许运行 `select`、`insert`、`update`、`delete` 语句。但是仍然有一些 `alter` 操作（比如：增加/删除列，增加/删除主键，改变数据类型等）需要重建表。并不建议直接在线上使用 `alter table`。建议使用以下两种方式：

### 主从架构轮询修改

这种方式使用的前提是使用了集群，修改的原理就是利用主从服务，在应用无感知的情况下，得到停机窗口，进行修改。

### 利用已有的工具

可以使用 online-schema-change 工具来进行 DDL。它会创建一个和要执行 `alter` 操作的表一样的空表，执行表结构修改，然后从原表中复制原始数据到新表中。当数据复制完成以后就会用新表代替原表，默认动作是将原表 `drop`。在复制数据的过程中，任何在原表的更新操作都会同步更新到新表，因为这个工具会在原表上创建了触发器。

## MySQL 有哪些约束？

- 非空约束：`not null`
- 唯一性约束：`unique`，表示具备唯一性，可为 `null`
- 主键约束：`primary key`
- 外键约束：`foreign key`
- 检查约束：`check`，MySQL 不支持
- 默认约束：`default`，保证字段会有一个默认值

## 数据库外键的优缺点？

- 优点
  - 能最大限度的保证数据的一致性和完整性
  - 增加 ER 图的可读性
- 缺点
  - 影响数据操作的效率
  - 增加开发难度，导致表过多
